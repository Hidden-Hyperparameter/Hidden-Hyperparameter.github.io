---
title: ZHH-013
paper: "Flow Matching for Generative Modeling"
paper_url: "https://arxiv.org/abs/2210.02747"
paper_year: 2022
tags: 
    - "Flow Matching"
layout: post
---

提出了Flow Matching的方法。基本思想就是，我们的生成过程是求解ODE

$$
\frac{dx}{dt}=v_\theta(x,t)
$$

其中，$v_\theta(x,t)$是神经网络，我们希望这个网络学会如何把$t=0$时刻的$x_0\sim p_0:= \mathcal{N}(0,1)$变成$t=1$时刻的数据集分布 $x_1\sim p_d$。

训练目标“Flow Matching”指的是，我们试图构造一个flow $u_t(x)$，使得它满足这个条件；然后，我们用神经网络近似它：

$$
L=\mathbb{E}_{t\sim \text{Uniform}(0,1)}\mathbb{E}_{x_t\sim p_t}\left[\left|v_\theta(x_t,t)-u_t(x_t)\right|^2\right]
$$

而这个$u_t(x)$的构造方式是通过**conditional normalizing flow**，其巧妙之处在于，虽然$u$本身是intractable的（涉及对数据集的积分），但loss是tractable的。最终的loss形如

$$
L=\mathbb{E}_{t\sim \text{Uniform}(0,1)}\mathbb{E}_{x_d\sim p_d}\mathbb{E}_{\epsilon \sim \mathcal{N}(0,1)}\left[\left|v_\theta(x_t,t)-u_t(x_t\mid x_d)\right|^2\right]
$$

其中, $x_t=\phi_t(\epsilon\mid x_d)$，而$\phi_t$和$u_t$是任意的函数，但需要满足以下的一些要求；$\phi_t(\epsilon\mid x_d)$代表初始是$\epsilon$的点的$t$时刻的位置，而$u_t(x_t\mid x_d)$代表在$t$时刻$x_t$处的速度。它们需要满足：

$$
\frac{d\phi_t(\epsilon\mid x_d)}{dt}=u_t(\phi_t(\epsilon\mid x_d)\mid x_d),\forall \epsilon,t,x_d
$$

（也就是，$\phi_t$就是由速度场$u_t$给出的ODE的解）；并且初始分布为

$$
\phi_0(\epsilon\mid x_d)=\epsilon
$$

最终分布为

$$
\phi_1(\epsilon\mid x_d)\approx x_d
$$

（实际上，一般选取$\phi$使得$\phi_1(\epsilon\mid x_d)$这一变量的分布是均值$x_d$，方差为$\sigma_m\ll 1$的高斯分布）

## 具体实现

上面的方法给出了一个一般的框架。但是具体问题中，我们需要选取$\phi_t$和$u_t$。给定$\phi_t$，我们一般就可以计算出来$u_t$。

$\phi_t$的选取方式一般是我们先指定一个分布$p_t$，然后再进行一个对应。一个常见的方法是我们选择

$$
p_t(x\mid x_d)=\mathcal{N}(\mu_t(x_d),\sigma_t(x_d))
$$

它们必须满足

$$
\mu_0(x_d)=0,\sigma_0(x_d)=1; \mu_1(x_d)=x_d,\sigma_1(x_d)=\sigma_m
$$

这个函数我们可以任意选取。这篇论文里选择了线性插值

$$
\mu_t(x_d)=tx_d,\sigma_t(x_d)=(1-t)+t\sigma_m
$$

给定了分布之后，我们还需要手动指定一个分布的对应方式。论文里选择了最直接的方式，也就是位似（我不知道这个词用的对不对）

$$
\phi_t(\epsilon\mid x_d)=\mu_t(x_d)+\sigma_t(x_d)\epsilon
$$

这对应的就可以很容易算出来

$$
\phi_t(\epsilon\mid x_d)=t x_d+(1-t+t\sigma_m)\epsilon,\quad u_t(x_t\mid x_d)=x_d+\epsilon (1-\sigma_m) = x_d + \frac{1-\sigma_m}{1-t+t\sigma_m}(x_t-tx_d)
$$

## 附录

更多内容，可以参考[demo](https://github.com/Hope7Happiness/papers/blob/main/Flow_Matching/pytorch/demo.ipynb)，包括一些推导和在toy dataset上的实现。